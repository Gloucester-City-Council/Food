<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOAP Connection Tester - Idox Uniform</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    header .logo {
      width: 48px; height: 48px;
      background: #e94560;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.85rem;
      flex-shrink: 0;
    }

    header h1 { font-size: 1.3rem; font-weight: 600; }
    header p  { font-size: 0.85rem; opacity: 0.8; }

    .container {
      max-width: 760px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #f0f2f5;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-group { display: flex; flex-direction: column; }
    .form-group.full { grid-column: 1 / -1; }

    .form-group label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #555;
      margin-bottom: 0.35rem;
    }

    .form-group input,
    .form-group select {
      padding: 0.65rem 0.85rem;
      border: 1.5px solid #d0d5dd;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.2s;
      background: #fff;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0f3460;
      box-shadow: 0 0 0 3px rgba(15,52,96,0.1);
    }

    .form-group .hint {
      font-size: 0.75rem;
      color: #888;
      margin-top: 0.25rem;
    }

    .btn-test {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.85rem;
      margin-top: 1.25rem;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #0f3460, #16213e);
      color: #fff;
      transition: opacity 0.2s, transform 0.1s;
    }

    .btn-test:hover { opacity: 0.9; }
    .btn-test:active { transform: scale(0.98); }
    .btn-test:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-test .spinner {
      display: none;
      width: 18px; height: 18px;
      border: 2.5px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    .btn-test.loading .spinner { display: inline-block; }
    .btn-test.loading .btn-label { display: none; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Result area */
    #resultArea { display: none; }

    .result-banner {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.25rem;
    }

    .result-banner.success {
      background: #ecfdf5;
      border: 1.5px solid #6ee7b7;
    }

    .result-banner.failure {
      background: #fef2f2;
      border: 1.5px solid #fca5a5;
    }

    .result-banner .thumb {
      font-size: 2.5rem;
      line-height: 1;
    }

    .result-banner .msg h3 { font-size: 1.05rem; margin-bottom: 0.2rem; }
    .result-banner .msg p  { font-size: 0.85rem; color: #555; }
    .result-banner.success .msg h3 { color: #065f46; }
    .result-banner.failure .msg h3 { color: #991b1b; }

    .step-list { list-style: none; }

    .step-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.85rem 0;
      border-bottom: 1px solid #f0f2f5;
    }

    .step-list li:last-child { border-bottom: none; }

    .step-icon {
      width: 28px; height: 28px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.85rem;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    .step-icon.pass  { background: #d1fae5; color: #065f46; }
    .step-icon.fail  { background: #fee2e2; color: #991b1b; }
    .step-icon.skip  { background: #e5e7eb; color: #6b7280; }

    .step-body strong { display: block; font-size: 0.9rem; }
    .step-body span   { font-size: 0.82rem; color: #666; word-break: break-word; }

    /* Aliases table */
    .alias-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.82rem;
    }

    .alias-table th {
      text-align: left;
      padding: 0.5rem 0.6rem;
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #475569;
    }

    .alias-table td {
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid #f0f2f5;
    }

    .alias-table tr:hover td { background: #f8fafc; }

    .badge-active {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
    }
    .badge-active.yes { background: #d1fae5; color: #065f46; }
    .badge-active.no  { background: #fee2e2; color: #991b1b; }

    footer {
      text-align: center;
      padding: 1.5rem;
      font-size: 0.8rem;
      color: #999;
    }

    footer a { color: #0f3460; text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container { padding: 0 0.5rem; }
      .card { padding: 1.25rem; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">GCC</div>
  <div>
    <h1>Idox Uniform SOAP Connection Tester</h1>
    <p>Gloucester City Council - Environmental Health</p>
  </div>
</header>

<div class="container">

  <!-- Credentials Form -->
  <div class="card">
    <h2>Connection Credentials</h2>
    <form id="connForm" onsubmit="runTest(event)">
      <div class="form-grid">
        <div class="form-group full">
          <label for="server">Server Hostname</label>
          <input type="text" id="server" placeholder="e.g. apphst56a.gloucester.idox" required>
          <span class="hint">Internal hostname of the Uniform application server (no http:// prefix)</span>
        </div>

        <div class="form-group">
          <label for="stateSwitch">Environment</label>
          <select id="stateSwitch">
            <option value="_TEST">TEST</option>
            <option value="_LIVE">LIVE</option>
          </select>
        </div>

        <div class="form-group">
          <label for="timeout">Timeout (seconds)</label>
          <input type="number" id="timeout" value="30" min="5" max="120">
        </div>

        <div class="form-group full">
          <label for="databaseId">Database ID / Alias</label>
          <input type="text" id="databaseId" placeholder="e.g. ORADBHST56a.gloucester.idox/IDOXLVE">
          <span class="hint">Leave blank to skip login test; discovered aliases will be shown below</span>
        </div>

        <div class="form-group">
          <label for="username">Uniform Username</label>
          <input type="text" id="username" placeholder="Your Uniform username" autocomplete="username">
        </div>

        <div class="form-group">
          <label for="password">Uniform Password</label>
          <input type="password" id="password" placeholder="Your Uniform password" autocomplete="current-password">
        </div>
      </div>

      <button type="submit" class="btn-test" id="testBtn">
        <span class="spinner"></span>
        <span class="btn-label">Test Connection</span>
      </button>
    </form>
  </div>

  <!-- Results -->
  <div id="resultArea">
    <div id="resultBanner" class="result-banner">
      <div class="thumb" id="resultThumb"></div>
      <div class="msg">
        <h3 id="resultTitle"></h3>
        <p id="resultSubtitle"></p>
      </div>
    </div>

    <div class="card">
      <h2>Test Steps</h2>
      <ul class="step-list" id="stepList"></ul>
    </div>

    <div class="card" id="aliasCard" style="display:none;">
      <h2>Discovered Database Aliases</h2>
      <p style="font-size:0.85rem;color:#666;margin-bottom:0.5rem;">
        These are the database aliases available on this Uniform server.
        Use one of these as your Database ID when logging in.
      </p>
      <table class="alias-table" id="aliasTable">
        <thead>
          <tr>
            <th>Database ID</th>
            <th>Description</th>
            <th>Active</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<footer>
  <p>Gloucester City Council &middot; Environmental Health Department</p>
  <p><a href="/">Back to Dashboard</a></p>
</footer>

<script>
async function runTest(e) {
  e.preventDefault();

  const btn = document.getElementById('testBtn');
  const resultArea = document.getElementById('resultArea');

  btn.classList.add('loading');
  btn.disabled = true;
  resultArea.style.display = 'none';

  const payload = {
    server:       document.getElementById('server').value.trim(),
    state_switch: document.getElementById('stateSwitch').value,
    database_id:  document.getElementById('databaseId').value.trim(),
    username:     document.getElementById('username').value.trim(),
    password:     document.getElementById('password').value.trim(),
    timeout:      parseInt(document.getElementById('timeout').value, 10) || 30,
  };

  let result;
  try {
    const resp = await fetch('/api/uniform/test-connection', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    result = await resp.json();
  } catch (err) {
    result = {
      success: false,
      wsdl_url: '',
      steps: [{ name: 'Network', passed: false, detail: 'Could not reach the Flask server: ' + err.message }],
    };
  }

  btn.classList.remove('loading');
  btn.disabled = false;

  renderResult(result);
}

function renderResult(result) {
  const area    = document.getElementById('resultArea');
  const banner  = document.getElementById('resultBanner');
  const thumb   = document.getElementById('resultThumb');
  const title   = document.getElementById('resultTitle');
  const sub     = document.getElementById('resultSubtitle');
  const list    = document.getElementById('stepList');
  const aliasCard  = document.getElementById('aliasCard');
  const aliasBody  = document.querySelector('#aliasTable tbody');

  area.style.display = 'block';

  const ok = result.success;
  banner.className = 'result-banner ' + (ok ? 'success' : 'failure');
  thumb.textContent = ok ? '\uD83D\uDC4D' : '\uD83D\uDC4E';
  title.textContent = ok ? 'Connection Successful' : 'Connection Failed';
  sub.textContent   = result.wsdl_url || '';

  // Steps
  list.innerHTML = '';
  (result.steps || []).forEach(function(step) {
    const li = document.createElement('li');

    const icon = document.createElement('div');
    icon.className = 'step-icon ' + (step.passed === true ? 'pass' : step.passed === false ? 'fail' : 'skip');
    icon.textContent = step.passed === true ? '\u2713' : step.passed === false ? '\u2717' : '\u2014';

    const body = document.createElement('div');
    body.className = 'step-body';

    const strong = document.createElement('strong');
    strong.textContent = step.name;

    const span = document.createElement('span');
    span.textContent = step.detail;

    body.appendChild(strong);
    body.appendChild(span);
    li.appendChild(icon);
    li.appendChild(body);
    list.appendChild(li);
  });

  // Aliases table
  var aliasStep = (result.steps || []).find(function(s) { return s.aliases && s.aliases.length; });
  if (aliasStep) {
    aliasCard.style.display = '';
    aliasBody.innerHTML = '';
    aliasStep.aliases.forEach(function(a) {
      var tr = document.createElement('tr');

      var tdId = document.createElement('td');
      tdId.textContent = a.database_id || '-';
      tdId.style.fontFamily = 'monospace';

      var tdDesc = document.createElement('td');
      tdDesc.textContent = a.description || '-';

      var tdActive = document.createElement('td');
      var badge = document.createElement('span');
      badge.className = 'badge-active ' + (a.is_active ? 'yes' : 'no');
      badge.textContent = a.is_active ? 'Active' : 'Inactive';
      tdActive.appendChild(badge);

      tr.appendChild(tdId);
      tr.appendChild(tdDesc);
      tr.appendChild(tdActive);
      aliasBody.appendChild(tr);
    });
  } else {
    aliasCard.style.display = 'none';
  }

  // Scroll to results
  area.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>

</body>
</html>
